AWSTemplateFormatVersion: '2010-09-09'
Description: 'Comprehensive CloudFormation template showcasing ALL complex syntax - GOOD STATE'

# Test Transform with multiple values
Transform:
  - 'AWS::Serverless-2016-10-31'
  - 'AWS::Include'

# Test complex metadata structures
Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: "Network Configuration"
        Parameters:
          - VpcCidr
          - EnvironmentName
    ParameterLabels:
      VpcCidr:
        default: "VPC CIDR Block"
  CustomMetadata:
    Version: "1.0.0"
    ComplexObject:
      NestedArray:
        - Item1
        - SubObject:
            Key1: Value1
            Key2: Value2

# Test ALL parameter types and constraints
Parameters:
  EnvironmentName:
    Type: String
    Default: "production"
    AllowedValues: ["development", "staging", "production"]
    ConstraintDescription: "Must be development, staging, or production"

  VpcCidr:
    Type: String
    Default: "10.0.0.0/16"
    AllowedPattern: "^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\\/(1[6-9]|2[0-8]))$"

  SubnetCidrs:
    Type: CommaDelimitedList
    Default: "10.0.1.0/24,10.0.2.0/24"

  DatabasePassword:
    Type: String
    NoEcho: true
    MinLength: 8
    MaxLength: 128

  InstanceCount:
    Type: Number
    Default: 2
    MinValue: 1
    MaxValue: 10

  AvailabilityZones:
    Type: List<AWS::EC2::AvailabilityZone::Name>
    Description: "List of AZs"

  SSMParameter:
    Type: AWS::SSM::Parameter::Value<String>
    Default: "/myapp/config/database-url"

  BooleanParameter:
    Type: String
    Default: "true"
    AllowedValues: ["true", "false"]

# Test complex nested mappings
Mappings:
  RegionMap:
    us-east-1:
      AMI: "ami-0abcdef1234567890"
      InstanceType: "t3.micro"
    us-west-2:
      AMI: "ami-0fedcba0987654321"
      InstanceType: "t3.small"

  EnvironmentMap:
    development:
      DatabaseSize: "db.t3.micro"
      LogLevel: "DEBUG"
    production:
      DatabaseSize: "db.t3.large"
      LogLevel: "WARN"

# Test ALL condition functions and complex nesting
Conditions:
  IsProduction: !Equals [!Ref EnvironmentName, "production"]
  IsNotProduction: !Not [!Condition IsProduction]
  IsDevelopment: !Equals [!Ref EnvironmentName, "development"]
  
  # Complex nested conditions
  IsProductionOrStaging: !Or
    - !Condition IsProduction
    - !Equals [!Ref EnvironmentName, "staging"]
  
  ComplexCondition: !And
    - !Condition IsProductionOrStaging
    - !Not [!Condition IsDevelopment]
    - !Equals [!Ref AWS::Region, "us-east-1"]
  
  HasMultipleAZs: !Not [!Equals [!Select [1, !Ref AvailabilityZones], ""]]

# Test rule validation with complex assertions
Rules:
  ValidateRegionAndEnvironment:
    RuleCondition: !Equals [!Ref AWS::Region, "us-east-1"]
    Assertions:
      - Assert: !Contains
          - ["t3.micro", "t3.small", "t3.medium"]
          - !FindInMap [RegionMap, !Ref AWS::Region, InstanceType]
        AssertDescription: "Instance type must be valid for region"
      - Assert: !And
          - !Not [!Equals [!Ref DatabasePassword, ""]]
          - !Not [!Equals [!Ref VpcCidr, ""]]
        AssertDescription: "Required parameters must not be empty"

  ValidateParameterCombinations:
    Assertions:
      - Assert: !Or
          - !Equals [!Ref EnvironmentName, "development"]
          - !And
            - !Not [!Equals [!Ref EnvironmentName, "development"]]
            - !Not [!Equals [!Select [1, !Ref AvailabilityZones], ""]]
        AssertDescription: "Non-development environments must specify multiple availability zones"
      - Assert: !Implies
          - !Equals [!Ref BooleanParameter, "true"]
          - !And
            - !Not [!Equals [!Ref InstanceCount, 1]]
            - !Not [!Equals [!Ref SSMParameter, ""]]
        AssertDescription: "When BooleanParameter is true, InstanceCount must be > 1 and SSMParameter must be provided"

Resources:
  # Test VPC with complex tagging and attributes
  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: !Ref VpcCidr
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: !Sub "${EnvironmentName}-vpc"
        - Key: Environment
          Value: !Ref EnvironmentName
    Metadata:
      Purpose: "Main VPC"
      CreatedBy: "CloudFormation"

  # Test subnet with complex intrinsic functions
  PublicSubnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Select [0, !Ref SubnetCidrs]
      AvailabilityZone: !Select [0, !Ref AvailabilityZones]
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub
            - "${EnvName}-public-subnet-${AZ}"
            - EnvName: !Ref EnvironmentName
              AZ: !Select [0, !Ref AvailabilityZones]
        - Key: Type
          Value: Public
    Condition: IsProductionOrStaging

  # Test security group with complex rules and references
  WebSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: "Security group with complex rules"
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
          Description: "HTTP access"
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
          Description: "HTTPS access"
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          SourceSecurityGroupId: !Ref BastionSecurityGroup
          Description: "SSH from bastion"
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: !Sub "${EnvironmentName}-web-sg"

  BastionSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: "Bastion security group"
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 0.0.0.0/0

  # Test launch template with complex user data and conditional properties
  LaunchTemplate:
    Type: AWS::EC2::LaunchTemplate
    Properties:
      LaunchTemplateName: !Sub "${EnvironmentName}-template"
      LaunchTemplateData:
        ImageId: !FindInMap [RegionMap, !Ref AWS::Region, AMI]
        InstanceType: !FindInMap [RegionMap, !Ref AWS::Region, InstanceType]
        SecurityGroupIds:
          - !Ref WebSecurityGroup
        TagSpecifications:
          - ResourceType: instance
            Tags:
              - Key: Name
                Value: !Sub "${EnvironmentName}-instance"
              - Key: Environment
                Value: !Ref EnvironmentName
    Metadata:
      AWS::CloudFormation::Designer:
        id: "launch-template-id"

  # Test Auto Scaling Group with complex configuration and policies
  AutoScalingGroup:
    Type: AWS::AutoScaling::AutoScalingGroup
    Properties:
      AutoScalingGroupName: !Sub "${EnvironmentName}-asg"
      LaunchTemplate:
        LaunchTemplateId: !Ref LaunchTemplate
        Version: !GetAtt LaunchTemplate.LatestVersionNumber
      DesiredCapacity: !Ref InstanceCount
      VPCZoneIdentifier:
        - !If [HasMultipleAZs, !Ref PublicSubnet, !Ref PublicSubnet]
      HealthCheckType: ELB
      HealthCheckGracePeriod: 300
      Tags:
        - Key: Name
          Value: !Sub "${EnvironmentName}-asg"
          PropagateAtLaunch: false
        - Key: Environment
          Value: !Ref EnvironmentName
          PropagateAtLaunch: true
    UpdatePolicy:
      AutoScalingRollingUpdate:
        MinInstancesInService: 1
        MaxBatchSize: 2
        PauseTime: PT5M
        WaitOnResourceSignals: true
    CreationPolicy:
      ResourceSignal:
        Count: !Ref InstanceCount
        Timeout: PT10M

  # Test RDS with complex conditional properties
  Database:
    Type: AWS::RDS::DBInstance
    Properties:
      DBInstanceIdentifier: !Sub "${EnvironmentName}-database"
      DBInstanceClass: !FindInMap [EnvironmentMap, !Ref EnvironmentName, DatabaseSize]
      Engine: mysql
      EngineVersion: "8.0"
      AllocatedStorage: !If [IsProduction, 100, 20]
      StorageType: gp2
      StorageEncrypted: !If [IsProduction, true, false]
      MasterUsername: admin
      MasterUserPassword: !Ref DatabasePassword
      VPCSecurityGroups:
        - !Ref DatabaseSecurityGroup
      BackupRetentionPeriod: !If [IsProduction, 7, 1]
      MultiAZ: !Condition IsProduction
      PubliclyAccessible: false
      Tags:
        - Key: Name
          Value: !Sub "${EnvironmentName}-database"
        - Key: Environment
          Value: !Ref EnvironmentName
    DeletionPolicy: !If [IsProduction, Snapshot, Delete]
    UpdateReplacePolicy: !If [IsProduction, Snapshot, Delete]

  DatabaseSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: "Database security group"
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          SourceSecurityGroupId: !Ref WebSecurityGroup

  # Test Lambda with complex environment variables and VPC config
  LambdaFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "${EnvironmentName}-function"
      Runtime: python3.9
      Handler: index.lambda_handler
      Role: !GetAtt LambdaRole.Arn
      Code:
        ZipFile: !Sub |
          import json
          import boto3
          
          def lambda_handler(event, context):
              return {
                  'statusCode': 200,
                  'body': json.dumps({
                      'environment': '${EnvironmentName}',
                      'region': '${AWS::Region}',
                      'database': '${Database}'
                  })
              }
      Environment:
        Variables:
          ENVIRONMENT: !Ref EnvironmentName
          DATABASE_ENDPOINT: !GetAtt Database.Endpoint.Address
          LOG_LEVEL: !FindInMap [EnvironmentMap, !Ref EnvironmentName, LogLevel]
          VPC_ID: !Ref VPC
      VpcConfig:
        SecurityGroupIds:
          - !Ref WebSecurityGroup
        SubnetIds:
          - !Ref PublicSubnet
      Tags:
        - Key: Name
          Value: !Sub "${EnvironmentName}-lambda"
    Condition: IsProductionOrStaging

  # Test IAM role with complex policy
  LambdaRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub "${EnvironmentName}-lambda-role"
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
        - arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole
      Policies:
        - PolicyName: DatabaseAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - rds:DescribeDBInstances
                  - rds:DescribeDBClusters
                Resource: !Sub "arn:aws:rds:${AWS::Region}:${AWS::AccountId}:db:${Database}"

  # Test CloudWatch alarm with complex dimensions and actions
  DatabaseAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub "${EnvironmentName}-database-cpu"
      AlarmDescription: "Database CPU utilization alarm"
      MetricName: CPUUtilization
      Namespace: AWS/RDS
      Statistic: Average
      Period: 300
      EvaluationPeriods: 2
      Threshold: 80
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: DBInstanceIdentifier
          Value: !Ref Database
      AlarmActions:
        - !Ref SNSTopic
      TreatMissingData: notBreaching
    Condition: IsProduction

  # Test SNS topic with complex attributes
  SNSTopic:
    Type: AWS::SNS::Topic
    Properties:
      TopicName: !Sub "${EnvironmentName}-alerts"
      DisplayName: !Sub "${EnvironmentName} Environment Alerts"
      KmsMasterKeyId: alias/aws/sns
      Tags:
        - Key: Name
          Value: !Sub "${EnvironmentName}-alerts"
        - Key: Environment
          Value: !Ref EnvironmentName

Outputs:
  # Test all output types and complex references
  VPCId:
    Description: "ID of the VPC"
    Value: !Ref VPC
    Export:
      Name: !Sub "${EnvironmentName}-VPC-ID"

  VPCCidr:
    Description: "CIDR block of the VPC"
    Value: !GetAtt VPC.CidrBlock
    Export:
      Name: !Sub "${EnvironmentName}-VPC-CIDR"

  DatabaseEndpoint:
    Description: "RDS database endpoint"
    Value: !GetAtt Database.Endpoint.Address
    Export:
      Name: !Sub "${EnvironmentName}-Database-Endpoint"
    Condition: IsProductionOrStaging

  # Test complex output with multiple functions
  ComplexOutput:
    Description: "Complex output demonstrating multiple functions"
    Value: !Sub
      - |
        Environment: ${Environment}
        VPC: ${VpcId} (${VpcCidr})
        Subnets: ${SubnetList}
        Database: ${DbEndpoint}:${DbPort}
        Instance Count: ${InstanceCount}
        Region AZs: ${AvailabilityZones}
        Max Scaling: ${MaxScaling}
      - Environment: !Ref EnvironmentName
        VpcId: !Ref VPC
        VpcCidr: !GetAtt VPC.CidrBlock
        SubnetList: !Join [", ", !Ref SubnetCidrs]
        DbEndpoint: !GetAtt Database.Endpoint.Address
        DbPort: !GetAtt Database.Endpoint.Port
        InstanceCount: !Ref InstanceCount
        AvailabilityZones: !Join [", ", !Ref AvailabilityZones]

  # Test conditional output with complex logic
  ConditionalOutput:
    Description: "Output that only exists in production"
    Value: !If
      - IsProduction
      - !Sub 
        - "Production environment in ${Region} with ${Count} instances"
        - Region: !Ref AWS::Region
          Count: !Ref InstanceCount
      - !Ref AWS::NoValue
    Condition: IsProduction

  # Test output with complex nested functions
  NestedFunctionOutput:
    Description: "Output with deeply nested functions"
    Value: !Select
      - 0
      - !Split
        - ","
        - !Sub
          - "${First},${Second},${Third}"
          - First: !FindInMap [RegionMap, !Ref AWS::Region, AMI]
            Second: !GetAtt Database.Endpoint.Address
            Third: !If [IsProduction, "prod", "dev"]
